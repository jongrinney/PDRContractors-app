<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="theme-color" content="#000000">
    <link rel="stylesheet" href="https://pdrcontractors.com/cms/plugins/foundation-6.4.2-custom/css/foundation.min.css">
    <link rel="stylesheet" href="https://pdrcontractors.com/cms/css/base.extended.css">
    <link rel="stylesheet" href="https://pdrcontractors.com/css/base.css">
    <link rel="stylesheet" href="https://pdrcontractors.com/css/extended.css">
    <link rel="stylesheet" href="fonts.css">
    <link rel="stylesheet" href="https://pdrcontractors.com/cms/modules/forms/css/forms.css">
	<link href='https://api.mapbox.com/mapbox.js/v3.1.1/mapbox.css' rel='stylesheet' />
    <link rel="stylesheet" href="style.css" />
    <title>PDR Contractors</title>
  </head>
  <body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    
	<main id="login">
		<div class="logo">
		</div>
		<form id="loginForm">
			<label>
				Username
				<input name="username" type="email" autocomplete="username" >
			</label>
			<label>
				Password
				<input name="password" type="password" autocomplete="current-password" >
			</label>
			<input class="button" type="submit" value="Login" style="width:100%">
		</form>
	</main>
    <main id="app">
		<nav>
			<a class="active" data-section="profile">Profile</a>
			<a data-section="map">View Map</a>
		<!--<a data-section="supporters">Supporters</a>-->
		</nav>
		<section id="profile">
			<form id="VendorsEditVendorForm">
				<article class="useGPS">
					<button type="button" onclick="getLocation()">USE CURRENT<br> GPS LOCATION</button>
					<input type="hidden" name="number_Current_Latitude">
					<input type="hidden" name="number_Current_Longitude">
				</article>
				<article class="box">
					<div class="rollup">
						<a>Manually Enter Current Location</a>
						<div class="content">
							<div id="currentLocationContainer"></div>
							<input type="submit" value="Save">
						</div>
					</div>
					<div class="rollup">
						<a>Change Business Options</a>
						<div class="content">
							<p>
								Check boxes that apply to your business for members-only directory listing.
							</p>
							<div id="businessOptionsContainer"></div>
						</div>
					</div>
					<div class="rollup">
						<a>Update Profile</a>
						<div class="content">
							<div id="profileContainer"></div>
							<p>
								Changes made to your profile must be approved by a site admin, and will not show immediately.
							</p>
							<input type="submit" value="Submit for review">
						</div>
					</div>
				</article>
			</form>
		</section>
		<section id="map">
		</section>
		<section id="supporters">
		</section>
	</main>
	
	<script src="pluginLoader.js"></script>
	<script>
		
		//prepare Template7
		window.T={};
		P.template7.ready(function(){
			T = Template7.templates = {};
			T.build = function(name,source,isPartial,cb){
				if(typeof T[name] === 'undefined' || (isPartial && typeof Template7.partials[name] === 'undefined')){
					if(source.substr(0,4) == 'http' || source.substr(0,1) == '/')
						$.get(source,function(data){
							T[name] = Template7.compile(data);
							if(isPartial)Template7.registerPartial(name, data);
							if(cb) cb(T[name]);
						},'text');
					else if($(source).length>0){
						T[name] = Template7.compile($(source).html());
						if(isPartial)Template7.registerPartial(name, $(source).html());
						if(cb) cb(T[name]);
					}
					else{
						T[name] = function(a){console.warn(a)};
						if(cb) cb(T[name]);
					}
				}
				else
					if(cb) cb(T[name]);
			};
			Template7.registerHelper('raw', function (condition, options) {
				return options.fn();
			});
		});
		window.format = function(type, string){
			console.log('format',type,string);
			if(string === null) return '';
			string = String(string);
			var orig = string;
			switch(type.trim()){
				case 'tel':
					string = ('' + string).replace(/\D/g, ''); //clean
					if(string.length==10)
						return 'tel:+1'+string;
					else if(string.length==11 && string.substr(0,1)=='1')
						return 'tel:+'+string;
					else
						return 'tel:'+string;
					break;
				case 'phone':
					string = ('' + string).replace(/\D/g, ''); //clean
					if(string.length==10 || (string.length==11 && string.substr(0,1)=='1')){
						if(string.length==11) string=string.substr(1);
						string = string.match(/^(\d{3})(\d{3})(\d{4})$/)
						if (string) 
							return '(' + string[1] + ') ' + string[2] + '-' + string[3];
					}
					break;
				case 'url':
					if(string.indexOf('http://')<0 && string.indexOf('https://')<0)
						string = 'http://'+string;
					return string;
					break;
				case 'link':
					return string.replace('http://','').replace('https://','').replace('www.','');
					break;
				case 'stateNameLong':
					var temp = string.toUpperCase();
					var states = {"AL": "Alabama","AK": "Alaska","AS": "American Samoa","AZ": "Arizona","AR": "Arkansas","CA": "California","CO": "Colorado","CT": "Connecticut","DE": "Delaware","DC": "District Of Columbia","FM": "Federated States Of Micronesia","FL": "Florida","GA": "Georgia","GU": "Guam","HI": "Hawaii","ID": "Idaho","IL": "Illinois","IN": "Indiana","IA": "Iowa","KS": "Kansas","KY": "Kentucky","LA": "Louisiana","ME": "Maine","MH": "Marshall Islands","MD": "Maryland","MA": "Massachusetts","MI": "Michigan","MN": "Minnesota","MS": "Mississippi","MO": "Missouri","MT": "Montana","NE": "Nebraska","NV": "Nevada","NH": "New Hampshire","NJ": "New Jersey","NM": "New Mexico","NY": "New York","NC": "North Carolina","ND": "North Dakota","MP": "Northern Mariana Islands","OH": "Ohio","OK": "Oklahoma","OR": "Oregon","PW": "Palau","PA": "Pennsylvania","PR": "Puerto Rico","RI": "Rhode Island","SC": "South Carolina","SD": "South Dakota","TN": "Tennessee","TX": "Texas","UT": "Utah","VT": "Vermont","VI": "Virgin Islands","VA": "Virginia","WA": "Washington","WV": "West Virginia","WI": "Wisconsin","WY": "Wyoming"};			
					if(typeof states[temp] !== 'undefined')
						return states[temp];
					else
						return string;
					break;
				case 'titleCase':
					return (string + '').replace(/^(.)|\s+(.)/g, function($1){return $1.toUpperCase(); });
					break;
					
			}
			return orig;
		}
		P.template7.ready(function(){
			Template7.registerHelper('format',format)
		});
		
		
		
		
		
		
		
		
		
		document.getElementById('login').classList.add('active');
		P.jquery.ready(function(){
			//init tabs
			$('nav a[data-section]').click(function(){
				$('section').removeClass('active').filter('#'+$(this).attr('data-section')).addClass('active');
				map.invalidateSize();
				navigator.geolocation.getCurrentPosition(function(position) {
					$('input[name="number_Current_Longitude"]').val(position.coords.latitude);
					$('input[name="number_Current_Longitude"]').val(position.coords.longitude);
					map.setView( [position.coords.latitude,position.coords.longitude], 9);
				});
			});
			
			//init rollups
			$('.rollup>a').click(function(){
				$(this).toggleClass('active');
				$(this).next().slideToggle();
				initForms();
			});
			
			//load profile form
			$.get('https://pdrcontractors.com/data/modules/vendors/module.htm',function(data){
				var $data = $(data);
				
				//current location
				$data.find('#VendorsEditVendorForm').children('.currentLocation').appendTo($('#currentLocationContainer'));
				$('#currentLocationContainer').find('.cell').first().remove();
				
				//business options
				$data.find('#VendorsEditVendorForm').children('.businessOptions').appendTo($('#businessOptionsContainer'));
				$('#businessOptionsContainer').find('.cell').first().remove();
				$('#businessOptionsContainer').find('fieldset').attr('data-type','toggle').unwrap().wrapInner('<div></div>');
				$('#businessOptionsContainer').find('input[type="checkbox"]').wrap('<label></label>').attr('data-values','No|Yes').attr('data-position','right').change(function(){
					saveData();
				});
				$('#businessOptionsContainer label:not([style])').click(function(){
					$(this).prev().trigger('click');
				});
				//update profile
				$data.find('#VendorsEditVendorForm').children().not('h1, .currentLocation, .businessOptions').appendTo($('#profileContainer'));
				$('#profileContainer .button').remove();
				
				//map
				$data.find('.vendorMap').appendTo($('#map'));
				//$data.find('#vendorsMap').appendTo($('#map'));
				//$data.find('.vendorMapSearch').appendTo($('#map'));
				
				//initForms();
				
				
			});
			
			$('#VendorsEditVendorForm').submit(function(){
				getLocation();
				return false;
			});
		});
		
		function getVendorId(){
			if(P.sweetalert.isLoaded) swal.showLoading();
				$.get('https://pdrcontractors.com/data/modules/vendors/json/loadVendors.json.php',function(data){
					window.vendorId = data.vendors[0].id;
					getUserData();
				});
		}
		
		function getUserData(){
			if(P.sweetalert.isLoaded) swal.showLoading();
			$.get('https://pdrcontractors.com/data/modules/vendors/json/getData.json.php',{id: window.vendorId},function(data){
				newGrid=true;
			
				if(P.sweetalert.isLoaded) swal.hideLoading();
				if(data.message == 'good'){
					for(var i in data.data){
						if(i.indexOf('bool_')==-1)
							$(':input[name="'+i+'"]').val(data.data[i]);
						else if(i.indexOf('bool_')==0){
							if(data.data[i]=="No")data.data[i]=false;
							if(data.data[i]=="Yes")data.data[i]=true;
							$(':input[name="'+i+'"]').prop('checked',data.data[i]);
						}
						if(i.indexOf('img_')==0)
							$(':input[name="'+i+'"]').prev('img').attr('src','https://pdrcontractors.com'+data.data[i]);
					}
					$('.callout.warning, .callout.error').hide();
					if(data.data.dues_payment_status=='Ending Soon')$('.callout.warning').show();
					if(data.data.dues_payment_status=='Expired')$('.callout.error').show();
					if(data.data.status != 'Published')
						$('#Vendors .revertButton, #Vendors .vendorsButtonPublish, #Vendors .vendorsButtonPublishWithoutEmail').css('display','flex');
					$('#Vendors .editForm').show();
				}
			});
		}
		
		var cms={Vendors:{
			markers:[],
			populateMatchingVendors: function(vendors,markerOnly){
				cms.Vendors.tempVendors = vendors;
				cms.Vendors.tempMarkerOnly = markerOnly;
				if(typeof markerOnly == 'undefined' || markerOnly == false)
					T.build('event','https://pdrcontractors.com/data/templates/partial.vendorListAdmin.htm',false,function(template){
						if(vendors.length>0){
							var out ='<div class="bgBlue" style="padding:0.83em;"><div class="mid"><h2 style="display:inline">Directory List </h2>('+vendors.length+'&nbsp;RESULTS)</div><div style="float:right;margin-top: -46px;margin-right: 60px;white-space: nowrap;">Sort By: <select class="sortResultsBy"><option>Distance: Closest First</option><option>Established: Oldest First</option><option>Established: Newest First</option><option>Name: A-Z</option><option>Name: Z-A</option></select></div></div><div id="mapVendorResultsList" class="mid">';
							
							if(cms.Vendors.curSort == 'Distance: Closest First') vendors = vendors.sort(function(a,b) { return a.number_distance - b.number_distance;});
							if(cms.Vendors.curSort == 'Established: Oldest First') vendors = vendors.sort(function(a,b) { return a.text_year_established - b.text_year_established;});
							if(cms.Vendors.curSort == 'Established: Newest First') vendors = vendors.sort(function(a,b) { return b.text_year_established - a.text_year_established;});
							if(cms.Vendors.curSort == 'Name: A-Z') vendors = vendors.sort(function(a,b) { return a.text_Company_Name.localeCompare(b.text_Company_Name);});
							if(cms.Vendors.curSort == 'Name: Z-A') vendors = vendors.sort(function(a,b) { return b.text_Company_Name.localeCompare(a.text_Company_Name);});
							
							for(var i=0;i<vendors.length;i++){
								vendors[i].number_distance = Math.round(vendors[i].number_distance*10)/10;
								out+=template(vendors[i]);
							}
							out+='</div>';
							$('#mapVendorResults').html(out).show();
							
							$('#Vendors .sortResultsBy').val(cms.Vendors.curSort).change(function(){
								cms.Vendors.curSort = $(this).val();
								cms.Vendors.populateMatchingVendors(cms.Vendors.tempVendors, cms.Vendors.tempMarkerOnly);
							});
							$('#mapVendorResults .shortBio').click(function(){
								$(this).hide().next().show();
							});
						}
						else
							$('#mapVendorResults').html('').hide();
					});
				
				//remove existing pins
				markersLayer.clearLayers();
				while(markers.length>0){
					var marker = markers.pop().getElement();
					if(typeof marker !== 'undefined' && marker !== null)
						marker.remove();
				}
	
				//add marker
				for(var i=0;i<vendors.length;i++){
					var marker = L.marker(new L.LatLng(vendors[i].number_Latitude, vendors[i].number_Longitude), {icon: icon,draggable: false});
					marker.data = vendors[i];
					marker.bindPopup(
						vendors[i].text_Company_Name+'<br> \
						<a href="'+format('tel',vendors[i].text_Phone_Number)+'">'+format('phone',vendors[i].text_Phone_Number)+'</a><br> \
						<a href="'+format('url',vendors[i].text_Url)+'" target="_blank" rel="noopener nofollow">'+format('link',vendors[i].text_Url)+'</a><br> \
				<a onclick="window.scrollTo({top: $(\'#vendor'+vendors[i].numId+'\').offset().top-100,left: 0,behavior: \'smooth\'});">Click for more info ...</a>');
					//marker.addTo(map);
					markersLayer.addLayer(marker);
					marker.on('mousedown', function() {
						this.timeoutId = setTimeout(this.dblclick, 1000);
					}).on('mouseup mouseleave', function() {
						clearTimeout(this.timeoutId);
					});
					
					
					marker.on('click', function (e) {
						this.openPopup();
					});
					/*marker.on('mouseover', function (e) {
						this.openPopup();
					});*/
					marker.on('dblclick', function (e) {
						var data = this.data;
						if($('#vendor'+data.numId).length == 0){
							populateMatchingVendors(Vendors.tempVendors,false);
							setTimeout(function(){
								window.scrollTo({
									top: $('#vendor'+data.numId).offset().top-100,
									left: 0,
									behavior: 'smooth'
								});
							},500);
						}
						else
							window.scrollTo({
								top: $('#vendor'+data.numId).offset().top-100,
								left: 0,
								behavior: 'smooth'
							});
					});
						
					markers.push(marker);
				
					//var marker = L.marker(new L.LatLng(vendors[i].number_Latitude, vendors[i].number_Longitude), {icon: cms.Vendors.icon,draggable: false});
					//marker.bindPopup(vendors[i].text_Company_Name);
					//marker.addTo(map);
					//cms.Vendors.markers.push(marker);
				}
			}
		}};
		function initMap(){
			P.mapbox.init(function(){
				P['mapbox-cluster'].init(function(){
					L.mapbox.accessToken = 'pk.eyJ1IjoidmlzdWFsdm9pY2VkZXNpZ24iLCJhIjoiY2puZzhnYXBvMDBqYTN1cXp6d3lpdXJjNCJ9.jggXMUBp1ksOUMwruT9STA';
					window.map = L.mapbox.map('vendorsMap', 'mapbox.streets');
					window.markers = [];
					L.mapbox.styleLayer('mapbox://styles/visualvoicedesign/cjnugphck2elp2sn0md3mmzre');
					window.markersLayer = L.markerClusterGroup({
						maxClusterRadius:5,
						zoomToBoundsOnClick: false,
					});
					markersLayer.on('clusterclick', function (a) {
						a.layer.spiderfy();
					});
					map.addLayer(markersLayer);

					map.setView( [37.8,-96], 5);

					//disable scroll
					if (map.scrollWheelZoom) map.scrollWheelZoom.disable();
					
					map.on('moveend', function(){ 
						console.log('movened');
						var bounds = map.getBounds();
						console.log('bounds',bounds);
						var data = {
							lat1:bounds._southWest.lat,
							lon1:bounds._southWest.lng,
							lat2:bounds._northEast.lat,
							lon2:bounds._northEast.lng
						};
						$('section.map form input[type="checkbox"]:checked').each(function(){
							data[$(this).attr('name')]='on';
						})
						$.post('https://pdrcontractors.com/json/findNearestVendors.json.php',data,function(data){
							cms.Vendors.populateMatchingVendors(data.vendors);
						});
					});
			
					//format marker icon
					window.icon = L.icon({
						iconUrl: "https://pdrcontractors.com/imgs/site-identity/mstile-150x150.png",
						iconSize: [48, 48],
						iconAnchor: [24, 48],
						popupAnchor: [0, -48]
					});
				});
			});
			
			$('.refineSearch').unbind('click').click(function(){
				$(this).next().show();
				$(this).hide();
			});
			$('.refineSearch input[type="checkbox"]').unbind('click').click(function(){
				$(this).closest('form').trigger('submit');
			});
			
			$(".vendorMapSearch").unbind('submit').submit(function(e){
				$.post('https://pdrcontractors.com/json/findNearestVendors.json.php?mode=admin',$(this).serialize(),function(data){
					if(typeof data.bounds !== 'undefined')
						map.fitBounds(data.bounds);
					cms.Vendors.populateMatchingVendors(data.vendors);
				});
				e.preventDefault();
				return false;
			});
			$(".vendorMapSearch input").unbind('change').change(function(){
				$(this).closest('form').submit();
			});
		}
		
		function getLocation(){
			swal.showLoading();
			if (navigator.geolocation)
				navigator.geolocation.getCurrentPosition(function(position) {
					swal.hideLoading();
					console.log(position);
					$('input[name="number_Current_Latitude"]').val(position.coords.latitude);
					$('input[name="number_Current_Longitude"]').val(position.coords.longitude);
					saveData();
				},function(msg){
					swal.hideLoading();
					swal('Error',msg,'error');
				});
			else
				swal('Error','Geolocation is not supported.','error');
		}
		
		
		function saveData(){
			$('#VendorsEditVendorForm input[type="file"]').each(function(){ if($(this).val()=='')$(this).prop('disabled',true).addClass('formdataTempDisable');});
			var fd = new FormData($('#VendorsEditVendorForm').get(0));
			$('#VendorsEditVendorForm input[type="file"].formdataTempDisable').removeClass('formdataTempDisable').prop('disabled',false);
			fd.append('I_certify_that_all_information_given_above_is_true_to_the_best_of_my_knowledge',true);
			swal.showLoading();
			$.ajax({url:'https://pdrcontractors.com/data/modules/vendors/json/saveData.json.php',data:fd,processData:false,contentType:false,type:'POST',success:function(data){
				swal.hideLoading();
				if(data.message=='good'){
					if(data.changes)
						swal('Success','Some changes may be pending appproval from an administrator.','success').then(function(){
							getUserData();
						});
					else
						swal({
							title:'Success',
							text: 'Changes saved',
							type: 'success',
							timer: 1000,
							toast: true,
							showConfirmButton: false,
						}).then(function(){
							getUserData();
						});
				}
				else
					swal('Error',data.message,'error');
					
			}});
		}
	</script>
  </body>
</html>
